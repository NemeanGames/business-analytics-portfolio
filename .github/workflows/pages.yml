name: Build and Deploy Portfolio Pages

on:
  push:
    branches: [ "main" ]  # Rebuild site on pushes to main branch

jobs:
  build-deploy:
    runs-on: ubuntu-latest
        permissions:
        contents: write
    container:
      image: rocker/verse:4.3.1
    env:
      R_LIBS_USER: "$HOME/R"
      R_COMPILE_AND_INSTALL_PACKAGES: "never"
      TZ: "UTC"
      _R_CHECK_SYSTEM_CLOCK_: "FALSE"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: ${{ env.HOME }}/R
          key: ${{ runner.os }}-R-4.3.1-${{ hashFiles('**/projects/carwash-market-intelligence/analysis.R', '**/projects/carwash-market-intelligence/report.Rmd') }}
          restore-keys: ${{ runner.os }}-R-4.3.1-

      - name: Install R package dependencies
        run: |
          Rscript -e "install.packages(c('rmarkdown', 'ggplot2', 'dplyr', 'tidyr', 'forecast', 'tidytext'), repos='https://cloud.r-project.org')"

      - name: Build R Markdown reports
        run: |
          mkdir -p public
          Rscript -e "rmarkdown::render('README.md', output_file='index.html', output_dir='public', output_format='html_document')"
          Rscript -e "rmarkdown::render('projects/carwash-market-intelligence/report.Rmd', output_file='report.html', output_dir='public')"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          user_name: GitHub Actions
          user_email: actions@github.com
